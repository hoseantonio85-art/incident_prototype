<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Инцидент · Просмотр + привязка риска</title>
<style>
  /* ====== токены под твой стиль (можно быстро править) ====== */
  :root{
    --bg:#f5f7fb; --card:#fff; --panel:#f8fafc; --line:#e6e9ef; --text:#0f172a; --muted:#667085;
    --primary:#22c55e; --primary-d:#16a34a; --blue:#2563eb; --warn:#f59e0b;
    --okbg:#ecfdf5; --okbd:#a7f3d0; --warnbg:#fff7ed; --warnbd:#f59e0b; --errbg:#fef2f2; --errbd:#fecaca;
    --r:14px; --r-lg:20px; --shadow:0 18px 40px rgba(16,24,40,.14);
    --fs-12:12px; --fs-13:13px; --fs-14:14px; --fs-16:16px; --fs-18:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .page{padding:24px 24px 80px;display:flex;justify-content:center}
  .container{width:min(1080px,96vw)}
  .modal{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}

  /* header */
  .head{padding:16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff 0%,#f8fafc 100%)}
  .row{display:flex;align-items:center;gap:10px}
  .title{margin:0;font-size:var(--fs-18);font-weight:700}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-12);color:#475467}
  .chip.ok{background:var(--okbg);border-color:var(--okbd);color:#065f46}
  .tabs{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-13);color:#344054}
  .tab.active{background:#eef2ff;border-color:#c7d2fe;color:#1d4ed8}
  .btn{border:1px solid var(--line);background:#fff;color:#101828;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:var(--fs-14)}
  .btn:hover{background:#f9fafb}
  .btn.primary{background:linear-gradient(180deg,var(--primary),var(--primary-d));color:#fff;border-color:#12a150}

  /* assistant banner */
  .banner{margin:16px;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:
      radial-gradient(1200px 400px at 0% -20%, #e8f0ff, transparent 60%),
      radial-gradient(800px 300px at 100% -10%, #e6fff4, transparent 55%),
      var(--panel);}
  .banner-h{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--line)}
  .banner-h .title{font-size:var(--fs-16)}
  .banner-b{padding:14px 16px;display:flex;gap:16px;align-items:flex-start}
  .banner .icon{width:28px;height:28px;border-radius:8px;background:#e5edff;display:flex;align-items:center;justify-content:center;color:#1d4ed8;font-weight:700}
  .banner .actions{margin-left:auto;display:flex;gap:8px}
  .text-muted{color:var(--muted);font-size:var(--fs-13)}

  .content{display:grid;grid-template-columns:1fr 300px;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);overflow:hidden}
  .card-h{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:600}
  .card-b{padding:14px}
  .muted{color:var(--muted);font-size:var(--fs-12)}
  .pair{display:flex;justify-content:space-between;padding:6px 0}

  .sticky{position:sticky;bottom:0;padding:10px;border-top:1px solid var(--line);background:#ffffffcc;backdrop-filter:blur(4px);display:flex;gap:8px;justify-content:flex-end}

  /* drawer */
  .drawer{position:fixed;inset:0;pointer-events:none}
  .drawer .shade{position:absolute;inset:0;background:rgba(15,23,42,.35);opacity:0;transition:.2s}
  .drawer .panel{position:absolute;right:-440px;top:0;width:440px;height:100%;background:#fff;border-left:1px solid var(--line);box-shadow:var(--shadow);transition:.25s;padding:16px 16px 80px}
  .drawer.show{pointer-events:auto}
  .drawer.show .shade{opacity:1}
  .drawer.show .panel{right:0}
  .drawer h3{margin:2px 0 10px;font-size:var(--fs-16)}
  .input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:var(--fs-14)}
  .hl{margin:12px 0 6px;font-size:var(--fs-12);color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;margin:6px 6px 0 0;cursor:pointer}
  .opt{padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:8px;cursor:pointer} .opt:hover{background:#f9fafb}
  .drawer .footer{position:absolute;left:0;right:0;bottom:0;padding:10px;border-top:1px solid var(--line);background:#fff;display:flex;gap:8px;justify-content:flex-end}

  /* toast */
  .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s;font-size:var(--fs-14)}
  .toast.show{opacity:1;transform:none}
</style>
</head>
<body>
<div class="page">
  <div class="container">
    <div class="modal">
      <!-- ШАПКА -->
      <div class="head">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <h1 class="title">Недобросовестные практики продаж продуктов и услуг</h1>
            <span id="staleChip" class="chip" style="display:none">Связь устарела — обновите привязку</span>
          </div>
          <div class="row">
            <button class="btn">Редактировать</button>
          </div>
        </div>
        <div class="tabs">
          <span class="tab active">Последствия и возмещения</span>
          <span class="tab">Описание</span>
          <span class="tab">Причины</span>
          <span class="tab">Риски</span>
          <span class="tab">Меры</span>
          <span class="tab">Вложения</span>
        </div>
      </div>

      <!-- СООБЩЕНИЯ АССИСТЕНТА (единственное место со связью) -->
      <section id="assistant" class="banner"></section>

      <!-- КОНТЕНТ -->
      <div class="content">
        <div>
          <!-- Потери -->
          <div class="card">
            <div class="card-h">Какие потери?</div>
            <div class="card-b">
              <div class="pair"><div>Прямые</div><strong>10 000 000 ₽</strong></div>
              <div class="pair"><div>Косвенные</div><strong>5 000 000 ₽</strong></div>
              <div class="pair"><div>Потенциальные</div><strong>5 000 000 ₽</strong></div>
            </div>
          </div>

          <!-- Что произошло -->
          <div class="card" style="margin-top:10px">
            <div class="card-h">Что произошло?</div>
            <div class="card-b">
              <div class="muted">Описание инцидента</div>
              <div style="margin:6px 0 10px">Обнаружена пропажа статуэтки гигантского гуся в офисе продаж №204.</div>
              <div class="muted">Профиль риска</div>
              <div>Повреждение / утрата имущества</div>
            </div>
          </div>

          <!-- Где произошло -->
          <div class="card" style="margin-top:10px">
            <div class="card-h">Где произошло?</div>
            <div class="card-b">
              <div class="muted">Описание инцидента</div>
              <div>Обнаружена пропажа статуэтки гигантского гуся в офисе продаж №204.</div>
              <div class="muted" style="margin-top:8px">Структурное подразделение</div>
              <div>ООО СК Сбербанк страхование · Управление продаж</div>
            </div>
          </div>

          <!-- Когда произошло -->
          <div class="card" style="margin-top:10px">
            <div class="card-h">Когда произошло?</div>
            <div class="card-b">
              <div class="pair"><div class="muted">Начало</div><div>20.02.2024 · 17:15</div></div>
              <div class="pair"><div class="muted">Окончание</div><div>20.02.2024 · 14:23</div></div>
            </div>
          </div>

          <!-- Причина -->
          <div class="card" style="margin-top:10px">
            <div class="card-h">Какая причина?</div>
            <div class="card-b">
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <span class="chip" style="padding:4px 8px">Прочее</span>
                <strong>Внешнее мошенничество</strong>
              </div>
              <div class="muted" style="margin-top:6px">
                Сотрудник, ответственный за сохранность и использование имущества компании, допустил ошибку или небрежность…
              </div>
            </div>
          </div>

          <!-- Управляющие кнопки страницы -->
          <div class="card" style="margin-top:10px">
            <div class="card-b" style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn">Взять в работу</button>
              <button class="btn primary" onclick="approve()">Утвердить</button>
            </div>
          </div>
        </div>

        <!-- ПРАВАЯ КОЛОНКА -->
        <aside>
          <div class="card">
            <div class="card-h">Информация</div>
            <div class="card-b">
              <div class="pair"><div class="muted">Событие</div><div>EVE-4124001</div></div>
              <div class="pair"><div class="muted">Создано</div><div>01.02.2024</div></div>
              <div class="pair"><div class="muted">Автор</div><div>Самойлидис А. С.</div></div>
              <div class="pair"><div class="muted">Вид</div><div>Выявлено в рамках аудита</div></div>
            </div>
          </div>

          <!-- Небольшой блок только для прототипирования сценариев; можно удалить -->
          <div class="card" style="margin-top:10px">
            <div class="card-h">Действия (демо)</div>
            <div class="card-b" style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" onclick="setState('pending')">Смоделировать «Идёт поиск»</button>
              <button class="btn" onclick="setState('linked_exist')">Смоделировать «Риск привязан»</button>
              <button class="btn" onclick="setState('create_new')">Смоделировать «Создан новый риск»</button>
              <button class="btn" onclick="setState('failed')">Смоделировать «Ошибка / перезапуск»</button>
              <button class="btn" onclick="setState('stale')">Смоделировать «Связь устарела»</button>
              <button class="btn" onclick="openDrawer()">Перепривязать вручную</button>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<!-- ДРОВЕР -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="shade" onclick="closeDrawer()"></div>
  <div class="panel" role="dialog" aria-modal="true">
    <h3>Перепривязка риска</h3>
    <input id="search" class="input" type="text" placeholder="Поиск по рискам…" oninput="renderDrawer()"/>
    <div class="hl">Недавние риски вашего подразделения</div>
    <div id="recent"></div>
    <div class="hl">Результаты</div>
    <div id="results"></div>
    <div class="footer">
      <button class="btn" onclick="closeDrawer()">Отмена</button>
      <button id="bindBtn" class="btn primary" disabled onclick="bindSelected()">Привязать</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Сохранено</div>

<script>
  const $ = s => document.querySelector(s);
  function toast(t){ const el=$('#toast'); el.textContent=t; el.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>el.classList.remove('show'),1600);}

  /* Данные */
  const ALL_RISKS = [
    'Недобросовестные практики продаж',
    'Утечка персональных данных клиентов',
    'Повреждение / утрата имущества',
    'Сбой критической ИС',
    'Нарушение процедуры KYC',
    'Ошибочная выгрузка данных в CRM',
  ];
  const RECENT_RISKS = [
    'Повреждение / утрата имущества',
    'Сбой критической ИС',
    'Утечка персональных данных клиентов'
  ];

  /* Рендер ассистента (единственная зона про связь) */
  function renderAssistant(kind, data={}){
    const el = $('#assistant'); el.innerHTML='';
    const icon = `<div class="icon">i</div>`;
    let title='', text='', actions=[];

    if(kind==='pending'){
      title = 'Подбираю подходящий риск';
      text  = 'Я подбираю подходящий риск для связи с событием. Это может занять до 5 минут — вы можете продолжить работу и даже утвердить событие, привязка выполнится автоматически.';
      actions = [
        ['Перепривязать вручную', openDrawer]
      ];
    }
    if(kind==='linked_exist'){
      title = 'Риск привязан';
      text  = `Найден и привязан существующий риск <b>«${data.name||'Недобросовестные практики продаж'}»</b>. Утилизация учтена. Совпали ключевые фразы из описания и профиль риска.`;
      actions = [
        ['Перепривязать', openDrawer]
      ];
    }
    if(kind==='create_new'){
      title = 'Подходящий риск не найден — создан новый';
      text  = `По имеющимся данным подходящего риска не нашлось. Я создал риск <b>«${data.name||'Новый риск по событию'}»</b> и привязал его автоматически. Утилизация учтена.`;
      actions = [
        ['Перепривязать', openDrawer]
      ];
    }
    if(kind==='failed'){
      title = 'Не удалось привязать автоматически';
      text  = 'Техническая ошибка при подборе риска. Я перезапущу процесс, но вы можете выбрать риск вручную.';
      actions = [
        ['Выбрать вручную', openDrawer],
        ['Перезапустить поиск', ()=>setState('pending_then_new')]
      ];
    }
    if(kind==='stale'){
      $('#staleChip').style.display='';
      title = 'Детали события изменились';
      text  = 'Описание или причина были обновлены. Рекомендую запустить привязку ещё раз — чтобы учесть изменения и сохранить корректность утилизации.';
      actions = [
        ['Обновить привязку', ()=>setState('pending_then_new')]
      ];
    } else {
      if(kind!=='stale') $('#staleChip').style.display='none';
    }

    const h = `<div class="banner-h"><div class="title">${title}</div></div>`;
    const b = `<div class="banner-b">
      ${icon}
      <div style="max-width:720px">${text}</div>
      <div class="actions">${actions.map(([t,fn],i)=>`<button class="btn ${i===0?'primary':''}" data-a="${i}">${t}</button>`).join('')}</div>
    </div>`;
    el.innerHTML = h + b;
    el.classList.add('show');
    // навешиваем действия
    [...el.querySelectorAll('.actions .btn')].forEach((btn,i)=>{
      btn.onclick = actions[i][1];
    });
  }

  /* Простые сценарии для демо */
  function setState(kind){
    if(kind==='pending'){ renderAssistant('pending'); return; }
    if(kind==='linked_exist'){ renderAssistant('linked_exist',{name:'Недобросовестные практики продаж'}); return; }
    if(kind==='create_new'){ renderAssistant('create_new',{name:'Автосозданный риск по событию'}); return; }
    if(kind==='failed'){ renderAssistant('failed'); return; }
    if(kind==='stale'){ renderAssistant('stale'); return; }
    if(kind==='pending_then_new'){
      renderAssistant('pending');
      setTimeout(()=>renderAssistant('create_new',{name:'Автосозданный риск по событию'}), 3200);
      return;
    }
  }

  /* Жизненный цикл: как просили — «сначала поиск, потом создание нового» */
  function startFlow(){
    setState('pending_then_new');
  }

  function approve(){ toast('Событие утверждено. Привязка — в фоне.'); startFlow(); }

  /* Drawer (ручная перепривязка) */
  function openDrawer(){ $('#drawer').classList.add('show'); $('#search').value=''; selected=null; renderDrawer(); }
  function closeDrawer(){ $('#drawer').classList.remove('show'); }
  let selected=null;
  function renderDrawer(){
    const q = ($('#search').value||'').toLowerCase();
    const rec=$('#recent'); rec.innerHTML=''; RECENT_RISKS.forEach(n=>{const p=document.createElement('span');p.className='pill';p.textContent=n;p.onclick=()=>select(n);rec.append(p);});
    const res=$('#results'); res.innerHTML='';
    const list = ALL_RISKS.filter(n=>n.toLowerCase().includes(q)).slice(0,8);
    if(!list.length){ res.innerHTML='<div class="text-muted">Ничего не найдено</div>'; }
    list.forEach(n=>{const d=document.createElement('div');d.className='opt';d.textContent=n;d.onclick=()=>select(n);res.append(d);});
    $('#bindBtn').disabled = !selected;
  }
  function select(name){ selected=name; $('#bindBtn').disabled=false; toast(`Выбрано: ${name}`); }
  function bindSelected(){ if(!selected) return; closeDrawer(); renderAssistant('linked_exist',{name:selected}); toast('Связь обновлена. Утилизация перерасчитана.'); }

  // init
  startFlow();
</script>
</body>
</html>
